<!DOCTYPE html>
<html>
<head>
<title>Pro Walkie-Talkie</title>
<style>
body {
  font-family: sans-serif;
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 20px;
}

#status {
  margin-top: 10px;
  font-weight: bold;
}

#messages {
  margin-top: 20px;
  width: 300px;
}

.message {
  padding: 8px;
  border-bottom: 1px solid #eee;
}
</style>
</head>
<body>

<h1>Pro Walkie-Talkie</h1>

<div id="status">Initializing...</div>
<div id="messages"></div>

<script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
  import { getDatabase, ref, push, onValue, remove } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-database.js";

  // Your web app's Firebase configuration
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY", //REPLACE
    authDomain: "YOUR_PROJECT_ID.firebaseapp.com", //REPLACE
    databaseURL: "https://YOUR_PROJECT_ID-default-rtdb.firebaseio.com", //REPLACE
    projectId: "YOUR_PROJECT_ID", //REPLACE
    storageBucket: "YOUR_PROJECT_ID.appspot.com", //REPLACE
    messagingSenderId: "YOUR_MESSAGING_SENDER_ID", //REPLACE
    appId: "YOUR_APP_ID" //REPLACE
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const database = getDatabase(app);
  const messagesRef = ref(database, 'messages');

  const statusDiv = document.getElementById('status');
  const messagesDiv = document.getElementById('messages');

  let speechRecognition;
  let isListening = false;

  // Initialize Speech Recognition
  function initializeSpeechRecognition() {
    window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!window.SpeechRecognition) {
      statusDiv.textContent = "Speech recognition not supported in this browser.";
      return;
    }

    speechRecognition = new window.SpeechRecognition();
    speechRecognition.continuous = true;  // Keep listening
    speechRecognition.interimResults = false; // Only final results

    speechRecognition.onstart = () => {
      isListening = true;
      statusDiv.textContent = "Listening...";
    };

    speechRecognition.onresult = (event) => {
      const transcript = Array.from(event.results)
        .map(result => result[0])
        .map(result => result.transcript)
        .join('');

      // Send the transcript to Firebase
      push(messagesRef, { text: transcript, timestamp: Date.now() })
        .catch(error => {
          console.error("Error sending voice message:", error);
          statusDiv.textContent = "Error sending message.";
        });
    };

    speechRecognition.onerror = (event) => {
      console.error("Speech recognition error:", event.error);
      statusDiv.textContent = `Speech recognition error: ${event.error}`;
    };

    speechRecognition.onend = () => {
      isListening = false;
      statusDiv.textContent = "Idle. Restarting...";
      // Restart recognition automatically if it ends unexpectedly
      setTimeout(() => {
          if (!isListening) {
              startListening();
          }
      }, 1000); // Restart after 1 second
    };
  }

  // Function to speak text
  function speak(text) {
    const utterance = new SpeechSynthesisUtterance(text);
    window.speechSynthesis.speak(utterance);
  }

  // Start Listening Function
  function startListening() {
      if (speechRecognition) {
          try {
              speechRecognition.start();
          } catch (error) {
              console.error("Error starting speech recognition:", error);
              statusDiv.textContent = "Error starting recognition.";
              setTimeout(() => {startListening()}, 5000)
          }
      }
  }

  // Listen for new messages
  onValue(messagesRef, (snapshot) => {
    const messages = snapshot.val();
    if (messages) {
      Object.entries(messages).forEach(([key, message]) => {
        const messageElement = document.createElement('div');
        messageElement.classList.add('message');
        messageElement.textContent = message.text;
        messagesDiv.appendChild(messageElement);

        // Speak the message ONLY if it wasn't spoken by this client
        // (This is the key to prevent hearing yourself)
        if (!message.isFromThisClient) {  // Add this flag when sending.
          speak(message.text);
        }

        // Optional: Delete the message after speaking
        remove(ref(database, `messages/${key}`))
          .catch(error => {
            console.error("Error deleting message:", error);
          });
      });
    }

     //clear messages after reading
    messagesDiv.innerHTML = '';

  });

  // Initialize everything when the page loads
  window.addEventListener('load', () => {
    initializeSpeechRecognition();
    if (speechRecognition) {
      startListening(); // Start listening as soon as the page loads
    }
  });
</script>

</body>
</html>
