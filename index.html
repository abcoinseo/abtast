<!DOCTYPE html>
<html>
<head>
    <title>Pro Security Camera</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .camera-container {
            width: 600px;
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
            padding: 20px;
            text-align: center;
        }

        #camera-view {
            width: 100%;
            height: 300px;
            background-color: #ccc;
            border-radius: 5px;
            margin-bottom: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            position: relative; /* For overlay */
        }

        #camera-view video {
            max-width: 100%;
            max-height: 100%;
            object-fit: cover;
        }

        #face-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* Make it transparent to clicks */
        }

        .controls {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
        }

        button {
            padding: 10px 20px;
            border: none;
            background-color: #4CAF50;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        button:hover {
            background-color: #3e8e41;
        }

        #status {
            font-weight: bold;
            color: #555;
            margin-bottom: 10px;
        }

        /* Styles for alert */
        .alert {
            background-color: #fdd;
            color: #a00;
            border: 1px solid #f00;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            display: none; /* Initially hidden */
        }

         /* CSS for circle on/off */
         .circle-button {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: #ccc;
            border: none;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background-color 0.3s ease;
            margin: 5px;
        }

        .circle-button.on {
            background-color: #4CAF50;
        }

        .circle-button:hover {
            opacity: 0.8;
        }

    </style>
</head>
<body>

<div class="camera-container">
    <h1>Pro Security Camera</h1>

    <div id="camera-view">
        <video id="camera-video" autoplay playsinline muted></video>
        <canvas id="face-overlay"></canvas>
    </div>

    <div id="status">Status: Ready</div>

    <div class="controls">
        <button id="start-button">Start Monitoring</button>
        <button id="stop-button" disabled>Stop Monitoring</button>
        <button id="face-detection-toggle" class="circle-button">
            <span id="face-detection-icon">⚪</span> <!-- White Circle (off) -->
        </button>
    </div>

    <div id="alert-message" class="alert">
        Face Detected! Intruder Alert!
    </div>

    <audio id="alarm-sound" src="alarm.mp3" preload="auto"></audio>

    <div id="known-faces">
        <h3>Known Faces</h3>
        <ul id="known-faces-list"></ul>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/face-api.js@latest/dist/face-api.min.js"></script>
<script>
    const cameraVideo = document.getElementById('camera-video');
    const faceOverlay = document.getElementById('face-overlay');
    const statusDisplay = document.getElementById('status');
    const startButton = document.getElementById('start-button');
    const stopButton = document.getElementById('stop-button');
    const alertMessage = document.getElementById('alert-message');
    const alarmSound = document.getElementById('alarm-sound');
    const faceOverlayCtx = faceOverlay.getContext('2d');
    const faceDetectionToggle = document.getElementById('face-detection-toggle');
    const faceDetectionIcon = document.getElementById('face-detection-icon');
    const knownFacesList = document.getElementById('known-faces-list');

    let monitoringActive = false;
    let faceDetectionEnabled = true;
    let stream = null;
    let knownFaceDescriptors = []; // Stores the learned face descriptors
    let labeledFaceDescriptors = null;
    let faceDetectionInterval;

    // Load face-api.js models
    async function loadModels() {
        statusDisplay.textContent = "Status: Loading Face Detection Models...";
        await faceapi.nets.tinyFaceDetector.loadFromUri('./models'); //or ssdMobilenetv1
        await faceapi.nets.faceLandmark68Net.loadFromUri('./models');
        await faceapi.nets.faceRecognitionNet.loadFromUri('./models');
        await faceapi.nets.faceExpressionNet.loadFromUri('./models');
        statusDisplay.textContent = "Status: Face Detection Models Loaded";
        loadStoredFaces(); // Load known faces after models are loaded
    }

    async function startCamera() {
        try {
            stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
            cameraVideo.srcObject = stream;
            cameraVideo.onloadedmetadata = () => {
                faceOverlay.width = cameraVideo.videoWidth;
                faceOverlay.height = cameraVideo.videoHeight;
                statusDisplay.textContent = "Status: Camera Ready";
                loadModels(); // Load models after camera is ready
            };
        } catch (error) {
            console.error("Error accessing camera:", error);
            statusDisplay.textContent = "Status: Camera Error - " + error.message;
            alert("Error accessing camera. Please make sure you have granted permission.");
        }
    }

   // Function to load stored faces from local storage
    async function loadStoredFaces() {
        statusDisplay.textContent = "Status: Loading Known Faces...";

        const storedDescriptors = localStorage.getItem('knownFaceDescriptors');
        if (storedDescriptors) {
             labeledFaceDescriptors = await JSON.parse(storedDescriptors).map((ld) => {
                return new faceapi.LabeledFaceDescriptors(ld.label, ld.descriptors.map((d) => new Float32Array(d)));
            });

            statusDisplay.textContent = "Status: Known Faces Loaded";
            updateKnownFacesList();
        } else {
            statusDisplay.textContent = "Status: No Known Faces Stored";
        }
    }

    function startMonitoring() {
        if (!stream) {
            alert("Camera not initialized. Please try again.");
            return;
        }

        if(!labeledFaceDescriptors){
            alert("no face storage !!")
             return;
        }
        monitoringActive = true;
        startButton.disabled = true;
        stopButton.disabled = false;
        statusDisplay.textContent = "Status: Monitoring...";
        faceDetectionInterval = setInterval(detectFaces, 100);
    }

    function stopMonitoring() {
        monitoringActive = false;
        startButton.disabled = false;
        stopButton.disabled = true;
        statusDisplay.textContent = "Status: Ready";
        alertMessage.style.display = 'none';
        clearInterval(faceDetectionInterval);
        alarmSound.pause();
        alarmSound.currentTime = 0;
        faceOverlayCtx.clearRect(0, 0, faceOverlay.width, faceOverlay.height);
    }

    async function detectFaces() {
        if (!monitoringActive || !faceDetectionEnabled) return;

        const detectionOptions = new faceapi.TinyFaceDetectorOptions({ inputSize: 512, scoreThreshold: 0.3 });

        const fullFaceDescriptions = await faceapi.detectAllFaces(cameraVideo, detectionOptions)
            .withFaceLandmarks()
            .withFaceDescriptors();

         if (fullFaceDescriptions.length > 0) {
            const faceMatcher = new faceapi.FaceMatcher(labeledFaceDescriptors, 0.6);
            const results = fullFaceDescriptions.map(fd => faceMatcher.findBestMatch(fd.descriptor));

            faceOverlayCtx.clearRect(0, 0, faceOverlay.width, faceOverlay.height); // Clear before drawing

            results.forEach((bestMatch, i) => {
                const box = fullFaceDescriptions[i].detection.box;
                const drawBox = new faceapi.draw.DrawBox(box, { label: bestMatch.toString() });
                drawBox.draw(faceOverlay);

                if (bestMatch.toString() === 'unknown') {
                    console.log("Unknown face detected!");
                    showAlert();
                }
            });
        } else {
            faceOverlayCtx.clearRect(0, 0, faceOverlay.width, faceOverlay.height); // Clear if no faces
        }
    }

     // Function to show alert
    function showAlert() {
        alertMessage.style.display = 'block';
        alarmSound.play();
    }

    // Face detection toggle functionality
    faceDetectionToggle.addEventListener('click', () => {
        faceDetectionEnabled = !faceDetectionEnabled;
        if (faceDetectionEnabled) {
            faceDetectionToggle.classList.add('on');
            faceDetectionToggle.classList.remove('off');
            faceDetectionIcon.innerHTML = '⚫'; // Black Circle (on)
        } else {
            faceDetectionToggle.classList.remove('on');
            faceDetectionToggle.classList.add('off');
            faceDetectionIcon.innerHTML = '⚪'; // White Circle (off)
            faceOverlayCtx.clearRect(0, 0, faceOverlay.width, faceOverlay.height); // Clear overlay
        }
    });

    startButton.addEventListener('click', startMonitoring);
    stopButton.addEventListener('click', stopMonitoring);

    async function learnFace() {
        if (!stream) {
            alert("Camera not initialized. Please start the camera first.");
            return;
        }

        const label = prompt("Enter the name for this face:");
        if (!label) return;

        statusDisplay.textContent = "Status: Learning Face...";

        const detectionOptions = new faceapi.TinyFaceDetectorOptions({ inputSize: 512, scoreThreshold: 0.3 });
        const fullFaceDescription = await faceapi.detectSingleFace(cameraVideo, detectionOptions)
            .withFaceLandmarks()
            .withFaceDescriptor();

        if (!fullFaceDescription) {
            alert("No face detected. Please try again.");
            statusDisplay.textContent = "Status: Ready";
            return;
        }

         if (!labeledFaceDescriptors) {
            labeledFaceDescriptors = [];
          }
        labeledFaceDescriptors.push(new faceapi.LabeledFaceDescriptors(label, [fullFaceDescription.descriptor]));

        statusDisplay.textContent = "Status: Face Learned";
        storeFaces();
        updateKnownFacesList();

    }

        // Function to store faces in local storage
    function storeFaces() {
        if (labeledFaceDescriptors){
            const serializedDescriptors = JSON.stringify(labeledFaceDescriptors.map((ld) => {
                return {
                    label: ld.label,
                    descriptors: ld.descriptors.map((d) => Array.from(d)),
                };
            }));

             localStorage.setItem('knownFaceDescriptors', serializedDescriptors);
        }

    }

    // Function to update the list of known faces
    function updateKnownFacesList() {
        knownFacesList.innerHTML = ''; // Clear the list
         if(labeledFaceDescriptors){
            labeledFaceDescriptors.forEach(ld => {
                const listItem = document.createElement('li');
                listItem.textContent = ld.label;
                knownFacesList.appendChild(listItem);
            });
         }
    }

    // Button to learn a new face
    const learnFaceButton = document.createElement('button');
    learnFaceButton.textContent = "Learn Face";
    learnFaceButton.addEventListener('click', learnFace);
    document.querySelector('.controls').appendChild(learnFaceButton);

    // Load models and start camera
    startCamera();
</script>
<script>

</script>
</body>
</html>
