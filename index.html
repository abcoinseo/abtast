<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Camera App</title>
    <style>
        body {
            font-family: sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            background-color: #f0f0f0;
        }

        #camera-container {
            position: relative;
            width: 80%;
            max-width: 600px; /* Adjust as needed */
            margin-bottom: 20px;
        }

        #camera-feed {
            width: 100%;
            display: block;
            border-radius: 8px; /* Rounded corners */
        }

        #captured-image {
            width: 100%;
            display: none; /* Initially hidden */
            border-radius: 8px;
        }

        #controls {
            display: flex;
            justify-content: center;
            gap: 20px;
        }

        button {
            padding: 10px 20px;
            font-size: 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #3e8e41;
        }

        #download-link {
            display: none; /* Initially hidden */
            margin-top: 10px;
        }

        /* "Pro" features - just basic styling for show */
        #pro-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        #pro-controls input[type="range"] {
            width: 100px;
        }

        #pro-controls label {
            font-size: 14px;
        }

        #flash-button {
            background-color: #FFC107;
            color: black;
        }

        #flash-button:hover {
            background-color: #FF9800;
        }

        .hidden {
          display: none;
        }

    </style>
</head>
<body>

    <h1>Simple Camera App</h1>

    <div id="camera-container">
        <video id="camera-feed" autoplay playsinline></video>
        <canvas id="camera-canvas" style="display: none;"></canvas>
        <img id="captured-image" alt="Captured Image">
    </div>

    <div id="controls">
        <button id="start-camera">Start Camera</button>
        <button id="take-picture" disabled>Take Picture</button>
        <button id="retake-picture" class="hidden">Retake</button>
    </div>

    <a id="download-link" download="captured_image.jpg">Download Image</a>

    <div id="pro-controls">
        <div>
            <label for="brightness">Brightness:</label>
            <input type="range" id="brightness" min="0" max="2" step="0.1" value="1">
        </div>
        <div>
            <label for="contrast">Contrast:</label>
            <input type="range" id="contrast" min="0" max="2" step="0.1" value="1">
        </div>
        <button id="flash-button">Flash</button>
    </div>

    <script>
        const cameraFeed = document.getElementById('camera-feed');
        const capturedImage = document.getElementById('captured-image');
        const startCameraButton = document.getElementById('start-camera');
        const takePictureButton = document.getElementById('take-picture');
        const retakePictureButton = document.getElementById('retake-picture');
        const downloadLink = document.getElementById('download-link');
        const cameraCanvas = document.getElementById('camera-canvas');
        const brightnessControl = document.getElementById('brightness');
        const contrastControl = document.getElementById('contrast');
        const flashButton = document.getElementById('flash-button');

        let stream = null;
        let imageCapture = null;
        let flashEnabled = false;

        // Start camera function
        async function startCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false }); //prefer back camera
                cameraFeed.srcObject = stream;
                takePictureButton.disabled = false;
                startCameraButton.disabled = true;

                // Attempt to access ImageCapture (for more advanced control)
                try {
                    const track = stream.getVideoTracks()[0];
                    imageCapture = new ImageCapture(track);
                    console.log("ImageCapture API available.");
                } catch (error) {
                    console.warn("ImageCapture API not available:", error);
                    imageCapture = null;
                }

            } catch (error) {
                console.error('Error accessing camera:', error);
                alert('Unable to access camera. Please ensure permissions are granted.');
            }
        }


        async function takePicture() {
            if (!stream) {
                alert('Camera not started.');
                return;
            }

            try {
                let imageBitmap;

                if (imageCapture) {
                    imageBitmap = await imageCapture.grabFrame();  // grabFrame is faster
                } else {
                    // Fallback if ImageCapture is not available
                    cameraCanvas.width = cameraFeed.videoWidth;
                    cameraCanvas.height = cameraFeed.videoHeight;
                    const context = cameraCanvas.getContext('2d');
                    context.drawImage(cameraFeed, 0, 0, cameraCanvas.width, cameraCanvas.height);
                    imageBitmap = await createImageBitmap(cameraCanvas);
                }



                capturedImage.src = cameraCanvas.toDataURL('image/jpeg'); // Use canvas for consistent output
                capturedImage.style.display = 'block';
                cameraFeed.style.display = 'none';
                takePictureButton.classList.add('hidden');
                retakePictureButton.classList.remove('hidden');

                // Prepare download link
                downloadLink.href = cameraCanvas.toDataURL('image/jpeg');
                downloadLink.style.display = 'block';

            } catch (error) {
                console.error('Error taking picture:', error);
                alert('Error taking picture.  Check console for details.');
            }
        }

        function retakePicture() {
            capturedImage.style.display = 'none';
            cameraFeed.style.display = 'block';
            takePictureButton.classList.remove('hidden');
            retakePictureButton.classList.add('hidden');
            downloadLink.style.display = 'none';
        }


        function applyFilter() {
            // Get current values
            const brightness = brightnessControl.value;
            const contrast = contrastControl.value;

            // Apply filters directly to the video element.  Note:  This can be CPU intensive.  A canvas approach is generally better for performance.
            cameraFeed.style.filter = `brightness(${brightness}) contrast(${contrast})`;  // Simple brightness/contrast.  More complex filters would require a canvas.
        }

        async function toggleFlash() {
            if (!stream) return;

            const track = stream.getVideoTracks()[0];
            const capabilities = track.getCapabilities();

            if (!('torch' in capabilities)) {
                alert('Flash/Torch not supported on this device.');
                return;
            }

            flashEnabled = !flashEnabled;

            try {
                await track.applyConstraints({ advanced: [{ torch: flashEnabled }] });
                flashButton.textContent = flashEnabled ? 'Flash Off' : 'Flash On';
            } catch (error) {
                console.error('Error toggling flash:', error);
                alert('Error toggling flash.  Make sure camera permissions are granted.');
            }

        }


        startCameraButton.addEventListener('click', startCamera);
        takePictureButton.addEventListener('click', takePicture);
        retakePictureButton.addEventListener('click', retakePicture);

        brightnessControl.addEventListener('input', applyFilter);
        contrastControl.addEventListener('input', applyFilter);
        flashButton.addEventListener('click', toggleFlash);

    </script>
</body>
</html>
