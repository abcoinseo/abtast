<!DOCTYPE html>
<html>
<head>
<title>Pro Voice-Only Walkie-Talkie</title>
<style>
body {
  font-family: 'Arial', sans-serif;
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 20px;
  background-color: #f0f0f0;
}

h1 {
  color: #333;
  margin-bottom: 20px;
}

#status {
  margin-top: 10px;
  font-weight: bold;
  color: #555;
}

#messages {
  margin-top: 20px;
  width: 80%;
  max-width: 600px;
}

.message {
  padding: 10px;
  border-bottom: 1px solid #ddd;
  background-color: #fff;
  border-radius: 5px;
  margin-bottom: 5px;
  word-wrap: break-word; /* For long messages */
}
</style>
</head>
<body>

<h1>Pro Voice-Only Walkie-Talkie</h1>

<div id="status">Initializing...</div>
<div id="messages"></div>

<script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
  import { getDatabase, ref, push, onValue, remove } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-database.js";

  // Your web app's Firebase configuration
  const firebaseConfig = {
  apiKey: "AIzaSyBQMke0SOMIq0rod6vOm4jrFJ4cExfJPNE",
  authDomain: "ab-studio-4c309.firebaseapp.com",
  databaseURL: "https://ab-studio-4c309-default-rtdb.firebaseio.com",
  projectId: "ab-studio-4c309",
  storageBucket: "ab-studio-4c309.firebasestorage.app",
  messagingSenderId: "290321392308",
  appId: "1:290321392308:web:eed8f4bda17a51944eade1"
};

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const database = getDatabase(app);
  const messagesRef = ref(database, 'messages');

  const statusDiv = document.getElementById('status');
  const messagesDiv = document.getElementById('messages');

  let speechRecognition;
  let isListening = false;
  let clientId = Math.random().toString(36).substring(2, 15);

  // Function to report errors to UI
  function reportError(message) {
    console.error(message);
    statusDiv.textContent = `Error: ${message}`;
  }

  // Initialize Speech Recognition
  function initializeSpeechRecognition() {
    window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!window.SpeechRecognition) {
      reportError("Speech recognition not supported in this browser.");
      return;
    }

    speechRecognition = new window.SpeechRecognition();
    speechRecognition.continuous = true;
    speechRecognition.interimResults = false;
      speechRecognition.maxAlternatives = 5 // add more alternative for recognize close languages
    speechRecognition.onstart = () => {
      isListening = true;
      statusDiv.textContent = "Listening...";
    };

    speechRecognition.onresult = (event) => {
      let bestTranscript = "";
      let bestConfidence = 0;

      for (let i = 0; i < event.results.length; i++) {
          const result = event.results[i];
          for (let j = 0; j < result.length; j++) {
              const alternative = result[j];
              if (alternative.confidence > bestConfidence) {
                  bestTranscript = alternative.transcript;
                  bestConfidence = alternative.confidence;
              }
          }
      }


      if (bestTranscript) {
        // Send the transcript to Firebase
        push(messagesRef, {
          text: bestTranscript,
          timestamp: Date.now(),
          clientId: clientId
        })
          .catch(error => {
            reportError(`Error sending voice message: ${error}`);
          });
      }
    };

    speechRecognition.onerror = (event) => {
      reportError(`Speech recognition error: ${event.error}`);
    };

    speechRecognition.onend = () => {
      isListening = false;
      statusDiv.textContent = "Idle. Restarting...";
      setTimeout(() => {
          if (!isListening) {
              startListening();
          }
      }, 1000);
    };

    // Set initial languages. Try Bangla and English
    speechRecognition.lang = 'bn-BD'; // Attempt Bangla first

  }

  // Function to speak text (with language support and "real voice" attempt)
 function speak(text, lang) {
    const utterance = new SpeechSynthesisUtterance(text);

    // Set language - default to Bangla if undetermined
    utterance.lang = lang || 'bn-BD';


    // Attempt "real voice" (platform-dependent, may not work well)
    const voices = window.speechSynthesis.getVoices();
    let bestVoice = null;

    if (voices && voices.length > 0) {
      if (lang === 'bn-BD'){
          bestVoice = voices.find(voice => voice.lang === 'bn-BD');
      } else {
          bestVoice = voices.find(voice => voice.lang === 'en-US');
      }

    }
    if (bestVoice) {
      utterance.voice = bestVoice;
    }

    window.speechSynthesis.speak(utterance);
  }

  // Start Listening Function
  function startListening() {
      if (speechRecognition) {
          try {
              speechRecognition.start();
          } catch (error) {
              reportError(`Error starting speech recognition: ${error}`);
              setTimeout(() => {startListening()}, 5000)
          }
      }
  }

  // Listen for new messages
  onValue(messagesRef, (snapshot) => {
    const messages = snapshot.val();
    if (messages) {
      Object.entries(messages).forEach(([key, message]) => {
        const messageElement = document.createElement('div');
        messageElement.classList.add('message');
        messageElement.textContent = message.text;
        messagesDiv.appendChild(messageElement);

        // Speak the message ONLY if it wasn't sent by this client
        if (message.clientId !== clientId) {
          speak(message.text,  'bn-BD'); // or EN depend on test.
        }

        // Delete the message after speaking
        remove(ref(database, `messages/${key}`))
          .catch(error => {
            reportError(`Error deleting message: ${error}`);
          });
      });
    }
    messagesDiv.innerHTML = ''; //Clear messages after reading
  });

  // Initialize everything when the page loads
  window.addEventListener('load', () => {
    initializeSpeechRecognition();
    if (speechRecognition) {
      startListening();
    }
  });
</script>

</body>
</html>
