<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Object Detection Camera</title>
    <style>
        body {
            font-family: sans-serif;
            background-color: #111; /* Dark background */
            color: #ddd;
            display: flex;
            flex-direction: column; /* Up-to-down layout */
            align-items: center;
            padding: 20px;
        }

        h1 {
            color: #00bcd4; /* Jarvis-like color */
            margin-bottom: 20px;
        }

        .camera-container {
            position: relative;
            width: 640px;
            height: 480px;
            margin-bottom: 20px;
        }

        .camera-feed {
            width: 100%;
            height: 100%;
            background-color: #222;
        }

        .object-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* Allow clicks to pass through */
        }

        #alert-box {
            background-color: #d32f2f; /* Red alert */
            color: white;
            padding: 10px;
            margin-top: 10px;
            border-radius: 5px;
            display: none;
        }

        #object-list {
          list-style: none;
          padding: 0;
          margin: 0;
        }

        #object-list li {
          margin-bottom: 5px;
          padding: 5px;
          background-color: #444;
          border-radius: 5px;
        }

    </style>
    <!-- Include TensorFlow.js -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.16.0/dist/tf.min.js"></script>
    <!-- Include COCO-SSD model (or your preferred model) -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.2/dist/coco-ssd.min.js"></script>
    <!-- *IMPORTANT*:  Replace these with *LOCAL* files for production! -->
</head>
<body>

    <h1>Advanced Object Detection System</h1>

    <div class="camera-container">
        <h2>Camera 1</h2>
        <video id="camera-feed-1" class="camera-feed" autoplay muted></video>
        <canvas id="object-overlay-1" class="object-overlay"></canvas>
    </div>

    <div class="camera-container">
        <h2>Camera 2</h2>
        <video id="camera-feed-2" class="camera-feed" autoplay muted></video>
        <canvas id="object-overlay-2" class="object-overlay"></canvas>
    </div>

    <h2>Detected Objects:</h2>
    <ul id="object-list"></ul>

    <div id="alert-box">
        <strong>Alert:</strong> Unauthorized object detected! No Entry!
    </div>

    <script>
        // Configuration
        const unauthorizedObjects = ['person', 'car'];
        const detectionInterval = 1000; // Milliseconds
        const confidenceThreshold = 0.5; // Minimum confidence for detection

        // Get DOM elements
        const video1 = document.getElementById('camera-feed-1');
        const video2 = document.getElementById('camera-feed-2');
        const overlay1 = document.getElementById('object-overlay-1');
        const overlay2 = document.getElementById('object-overlay-2');
        const alertBox = document.getElementById('alert-box');
        const objectList = document.getElementById('object-list');

        let model = null; // TensorFlow.js model
        let speaking = false; // Flag to prevent overlapping speech

        async function loadModel() {
            try {
                model = await cocoSsd.load(); // Use cocoSsd for now
                console.log("Model loaded.");
            } catch (error) {
                console.error("Error loading model:", error);
                alert("Failed to load object detection model. Check console for errors.");
            }
        }

        async function getCameraStream(videoElement) {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                videoElement.srcObject = stream;
            } catch (error) {
                console.error('Error accessing camera:', error);
                alert('Error accessing camera.  Ensure you have a camera and have granted permission.');
            }
        }

        function detectObjects(videoElement, overlayElement) {
            if (!model) return; // Model not loaded yet

            model.detect(videoElement)
                .then(predictions => {
                    drawBoxes(predictions, videoElement, overlayElement);
                    const detectedObjectNames = predictions.map(p => p.class);
                    displayObjects(detectedObjectNames);
                    checkForAlert(detectedObjectNames);
                })
                .catch(error => {
                    console.error("Error detecting objects:", error);
                });
        }

        function drawBoxes(predictions, videoElement, overlayElement) {
            const ctx = overlayElement.getContext('2d');
            ctx.clearRect(0, 0, overlayElement.width, overlayElement.height); // Clear previous boxes
            overlayElement.width = videoElement.videoWidth;
            overlayElement.height = videoElement.videoHeight;

            predictions.forEach(prediction => {
                if (prediction.score > confidenceThreshold) {
                    const [x, y, width, height] = prediction.bbox;

                    ctx.beginPath();
                    ctx.rect(x, y, width, height);
                    ctx.lineWidth = 2;
                    ctx.strokeStyle = '#00bcd4'; // Highlight color
                    ctx.fillStyle = '#00bcd422'; // Semi-transparent fill
                    ctx.fill();
                    ctx.stroke();

                    ctx.font = '16px sans-serif';
                    ctx.fillStyle = '#fff';
                    ctx.fillText(prediction.class + ' (' + Math.round(prediction.score * 100) + '%)', x + 5, y + 20);
                }
            });
        }

        function checkForAlert(objects) {
          const unauthorizedDetected = objects.some(object => unauthorizedObjects.includes(object.toLowerCase()));

            if (unauthorizedDetected && !speaking) {
                speaking = true;
                speak("Unauthorized object detected! No Entry!");
                alertBox.style.display = 'block';
                setTimeout(() => {
                    speaking = false; // Allow speaking again after a delay
                    alertBox.style.display = 'none';
                }, 5000); // Alert for 5 seconds
            }

        }

        function speak(text) {
            const utterance = new SpeechSynthesisUtterance(text);
            window.speechSynthesis.speak(utterance);
        }

        function displayObjects(objects) {
            objectList.innerHTML = ''; // Clear the list
            objects.forEach(objectName => {
                const listItem = document.createElement('li');
                listItem.textContent = objectName;
                objectList.appendChild(listItem);
            });
        }

        // Initialize
        async function init() {
            await loadModel();
            await getCameraStream(video1);
            await getCameraStream(video2);

            // Start detection loops
            setInterval(() => detectObjects(video1, overlay1), detectionInterval);
            setInterval(() => detectObjects(video2, overlay2), detectionInterval);
        }

        init();

    </script>
</body>
</html>
